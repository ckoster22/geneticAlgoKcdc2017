<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Evolving Images with a Genetic Algorithm</title>
  </head>
  <body>
    <div>
        <video id="screenshot-stream" autoplay></video>
        <canvas id="screenshot-canvas"></canvas>
        <p>
            <button id="captureButton">Capture / Take Snapshot</button>
            <button id="stopButton">Stop</button>
        </p>
    </div>
    <canvas id="gaCanvas" width="640" height="480"></canvas>
    <canvas id="bestSoFarCanvas" width="640" height="480"></canvas>
    <img src="" id="imagePlayback" />
    <button id="playMovieButton">Play Movie</button>

    <script>
      window.start = function(setImageCb) {
          console.log('calling init');
          var canvas = document.querySelector('#screenshot-canvas');//$('#screenshot-canvas')[0];
          var ctx = canvas.getContext('2d');
          var localMediaStream;
          var errorCallback;

          document.querySelector('#stopButton').addEventListener('click', stop);
          document.querySelector('#captureButton').addEventListener('click', takeSnapshot);
          // $('#stopButton').on('click', stop);
          // $('#captureButton').on('click', takeSnapshot);

          function errorCallback(error) {
              console.log('There was a problem with using your webcam! %o', error);
          };

          function takeSnapshot() {
              console.log('calling takeSnapshot');
              if (localMediaStream) {
                  snapshot();
              } else {
                  if (navigator.mediaDevices.getUserMedia) {
                      navigator.mediaDevices.getUserMedia({audio: false, video: true}).then(function(stream) {
                          document.querySelector('#screenshot-stream').src = window.URL.createObjectURL(stream);
                          localMediaStream = window.URL.createObjectURL(stream);
                          sizeCanvas();
                      }).catch(errorCallback);
                  } else if (navigator.webkitGetUserMedia) {
                      navigator.webkitGetUserMedia({video: true}, function(stream) {
                          document.querySelector('#screenshot-stream').src = window.URL.createObjectURL(stream);
                          localMediaStream = stream;
                          sizeCanvas();
                      }, errorCallback);
                  }
              }
          };

          function stop() {
              console.log('calling stop');
              document.querySelector('#screenshot-stream').pause();
              // localMediaStream.stop(); // Doesn't do anything in Chrome
              // document.querySelector('#screenshot-stream').hidden = true;
          };

          function sizeCanvas() {
              console.log('calling sizeCanvas');
              // video.onloadedmetadata not firing in Chrome so we have to hack.
              // See crbug.com/110938.
              setTimeout(function() {
                  canvas.width = document.querySelector('#screenshot-stream').videoWidth;
                  canvas.height = document.querySelector('#screenshot-stream').videoHeight;
                  console.log('OK now click the capture button');
              }, 2000); // stupid shit
          }

          function snapshot() {
              console.log('calling snapshot');
              ctx.drawImage(document.querySelector('#screenshot-stream'), 0, 0);
              setImageCb(ctx.getImageData(0, 0, canvas.width, canvas.height));
              stop();
          }
      }
    </script>
    <script src="../../build/evolving.images.bundle.js"></script>
  </body>
</html>